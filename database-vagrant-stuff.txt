config.vm.define "database" do |database|

  database.vm.hostname = "database"
  database.vm.network "forwarded_port", guest: 80, host: 8080, host_ip: "127.0.0.1"
  database.vm.network "private_network", ip: "192.168.33.11"
  database.vm.synced_folder ".", "/vagrant", owner: "vagrant", group: "vagrant", mount_options: ["dmode=775,fmode=777"]

  database.vm.provision "shell", inline: <<-SHELL
    apt-get update
    export MYSQL_PWD='insecure_mysqlroot_pw'

    # If you run the `apt-get install mysql-server` command
    # manually, it will prompt you to enter a MySQL root
    # password. The next two lines set up answers to the questions
    # the package installer would otherwise ask ahead of it asking,
    # so our automated provisioning script does not get stopped by
    # the software package management system attempting to ask the
    # user for configuration information.
    echo "mysql-server mysql-server/root_password password $MYSQL_PWD" | debconf-set-selections
    echo "mysql-server mysql-server/root_password_again password $MYSQL_PWD" | debconf-set-selections

    # Install the MySQL database server.
    apt-get -y install mysql-server

    # Run some setup commands to get the database ready to use.
    # First create a database.
    echo "CREATE DATABASE fvision;" | mysql

    # Then create a database user "webuser" with the given password.
    echo "CREATE USER 'webuser'@'%' IDENTIFIED BY 'insecure_db_pw';" | mysql

    # Grant all permissions to the database user "webuser" regarding
    # the "fvision" database that we just created, above.
    echo "GRANT ALL PRIVILEGES ON fvision.* TO 'webuser'@'%'" | mysql

    # Set the MYSQL_PWD shell variable that the mysql command will
    # try to use as the database password ...
    export MYSQL_PWD='insecure_db_pw'
    cat /vagrant/database.sql | mysql -u webuser fvision
    sed -i'' -e '/bind-address/s/127.0.0.1/0.0.0.0/' /etc/mysql/mysql.conf.d/mysqld.cnf

    # We then restart the MySQL server to ensure that it picks up
    # our configuration changes.
    service mysql restart
  SHELL
end
